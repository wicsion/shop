{% extends "main/base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto py-8">
    <div class="flex items-center mb-6">
        <h1 class="text-2xl font-bold">
            {% if preview_mode %}
                Предпросмотр товара
            {% else %}
                Конструктор товара:
            {% endif %}
        </h1>
        <div class="ml-4 bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">
            {{ product.name }}
        </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        <!-- Design area -->
        <div class="lg:w-2/3">
            <div class="bg-white rounded-lg shadow-md p-4">
                {% if not preview_mode %}
<div class="flex flex-col sm:flex-row justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm">
    <div class="flex space-x-2 mb-2 sm:mb-0 w-full sm:w-auto">
        <button id="front-btn" class="btn btn-primary flex-1 sm:flex-none">
            <i class="fas fa-tshirt mr-2"></i>Лицевая сторона
        </button>
        {% if back_image %}
        <button id="back-btn" class="btn btn-outline flex-1 sm:flex-none">
            <i class="fas fa-tshirt mr-2"></i>Тыльная сторона
        </button>
        {% endif %}
    </div>
    <div class="flex space-x-2 w-full sm:w-auto -mt-2 -sm:mt-0">
        <button id="add-text-btn" class="btn btn-outline flex-1 sm:flex-none">
            <i class="fas fa-font mr-2"></i>Добавить текст
        </button>
        <button id="add-image-btn" class="btn btn-outline flex-1 sm:flex-none">
            <i class="fas fa-image mr-2"></i>Добавить изображение
        </button>
    </div>
</div>
                {% endif %}

                <div class="relative" id="design-container" style="background-color: #f0f0f0;">
                    {% if front_image %}
                    <img id="product-image" src="{{ front_image.image.url }}"
                         class="w-full h-auto" alt="Product template">
                    {% endif %}

                    <!-- Color overlay will be inserted here by JavaScript -->

                    <!-- Front side elements container -->
                  <!-- Front side elements container -->
<div id="front-elements-container" class="absolute inset-0" style="z-index: 10;">
    {% for element in design.elements.all %}
        {% if element.side == 'front' %}
        <div class="design-area absolute p-0"
             style="left: {{ element.area.x_position }}px; top: {{ element.area.y_position }}px;
                    width: {{ element.area.width }}px; height: {{ element.area.height }}px;"
             data-area-id="{{ element.area.id }}" data-element-id="{{ element.id }}">
            <div class="area-content h-full flex items-center justify-center">
                {% if element.has_image %}
                    <img src="{{ element.get_image_url }}" class="max-w-full max-h-full element-display"
                         style="transform: rotate({{ element.rotation }}deg); mix-blend-mode: normal;"
                         data-element-id="{{ element.id }}" data-area-id="{{ element.area.id }}">
                {% elif element.text_content %}
                    <span class="element-display"
                          style="color: {{ element.color }}; font-size: {{ element.font_size }}px;
                                 transform: rotate({{ element.rotation }}deg); width: 100%;
                                 text-align: center; display: flex; align-items: center;
                                 justify-content: center;"
                          data-element-id="{{ element.id }}" data-area-id="{{ element.area.id }}">
                        {{ element.text_content }}
                    </span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>

                    <!-- Back side elements container (hidden by default) -->
                    {% if back_image %}
                    <div id="back-elements-container" class="absolute inset-0 hidden">
                        {% for element in design.elements.all %}
                            {% if element.side == 'back' %}
                            <div class="design-area absolute p-0"
                                 style="left: {{ element.area.x_position }}px; top: {{ element.area.y_position }}px;
                                        width: {{ element.area.width }}px; height: {{ element.area.height }}px;"
                                 data-area-id="{{ element.area.id }}" data-element-id="{{ element.id }}">
                                <div class="area-content h-full flex items-center justify-center">
                                    {% if element.has_image %}
                                        <img src="{{ element.get_image_url }}" class="max-w-full max-h-full element-display"
                                             style="transform: rotate({{ element.rotation }}deg);"
                                             data-element-id="{{ element.id }}" data-area-id="{{ element.area.id }}">
                                    {% elif element.text_content %}
                                        <span class="element-display"
                                              style="color: {{ element.color }}; font-size: {{ element.font_size }}px;
                                                     transform: rotate({{ element.rotation }}deg); width: 100%;
                                                     text-align: center; display: flex; align-items: center;
                                                     justify-content: center;"
                                              data-element-id="{{ element.id }}" data-area-id="{{ element.area.id }}">
                                            {{ element.text_content }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Controls section -->
        <div class="lg:w-1/4">
            <div class="bg-white rounded-lg shadow-xl p-6 sticky top-4 border border-gray-100">
                {% if not preview_mode %}
                <div id="element-controls" class="mb-6 hidden bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-3 text-gray-800 border-b pb-2">Редактирование элемента</h3>

                    <div class="mb-4">
                        <label class="block mb-2 text-sm font-medium text-gray-700">Текст</label>
                        <input type="text" id="element-text" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="mb-4">
                        <label class="block mb-2 text-sm font-medium text-gray-700">Цвет текста</label>
                        <div class="flex items-center gap-3">
                            <input type="color" id="element-color" value="#000000" class="w-10 h-10 rounded-lg cursor-pointer border border-gray-300">
                            <span id="color-hex-value" class="text-sm font-mono bg-gray-100 px-2 py-1 rounded">#000000</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block mb-2 text-sm font-medium text-gray-700">Размер шрифта</label>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-font text-gray-500 text-sm"></i>
                            <input type="range" id="element-font-size" min="8" max="72" value="14" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="font-size-value" class="text-sm font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">14px</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block mb-2 text-sm font-medium text-gray-700">Вращение</label>
                        <div class="flex items-center gap-3">
                            <i class="fas fa-undo text-gray-500 text-sm"></i>
                            <input type="range" id="element-rotation" min="0" max="360" value="0" class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <span id="rotation-value" class="text-sm font-medium bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0°</span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="block mb-2 text-sm font-medium text-gray-700">Изображение</label>
                        <div class="flex items-center gap-2">
                            <label for="element-image" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 px-4 rounded-lg border border-gray-300 text-sm font-medium transition-colors">
                                <i class="fas fa-upload mr-2"></i>Загрузить
                            </label>
                            <input type="file" id="element-image" class="hidden" accept="image/*">
                            <span id="image-filename" class="text-xs text-gray-500 truncate max-w-[100px]"></span>
                        </div>
                    </div>

                    <div class="flex justify-between gap-2 mt-6">
                        <button id="save-element-btn" class="btn btn-primary flex-1">
                            <i class="fas fa-save mr-2"></i>Сохранить
                        </button>
                        <button id="delete-element-btn" class="btn btn-danger">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button id="cancel-edit-btn" class="btn btn-outline">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                {% endif %}

                <div id="product-controls">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">Настройки товара</h3>

                    {% if not preview_mode %}
                    <!-- Color settings -->
                    <div class="mb-6">
                        <label class="block mb-3 text-sm font-medium text-gray-700">Цвет товара</label>

                        <div class="flex gap-2 mb-3">
                            <button class="color-type-btn btn btn-primary px-3 py-1 text-sm" data-type="solid">
                                <i class=""></i> Сплошной
                            </button>
                            <button class="color-type-btn btn btn-outline px-3 py-1 text-sm" data-type="gradient">
                                <i class=""></i> Градиент
                            </button>
                            <button class="color-type-btn btn btn-outline px-3 py-1 text-sm" data-type="pattern">
                                <i class=""></i> Текстура
                            </button>
                        </div>

                        <!-- Solid colors -->
                        <div id="solid-colors" class="color-options mb-4">
                            <div class="grid grid-cols-8 gap-2 mb-3">
                                {% for color in colors %}
                                <div class="color-option w-8 h-8 rounded-lg cursor-pointer border-2 hover:border-blue-300 transition-all
                                            {% if color == selected_color and not color.is_pattern and not color.gradient_css %}border-blue-500 ring-2 ring-blue-200{% else %}border-transparent{% endif %}"
                                     style="background-color: {{ color.hex_code }}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                     data-color-id="{{ color.id }}"
                                     data-color-type="solid"
                                     data-color-value="{{ color.hex_code }}"
                                     title="{{ color.name }}">
                                </div>
                                {% endfor %}
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <label class="block mb-2 text-sm font-medium text-gray-700">Добавить свой цвет</label>
                                <div class="flex gap-2">
                                    <input type="color" id="custom-solid-color" value="#000000" class="flex-1 h-10 rounded-lg cursor-pointer border border-gray-300">
                                    <button id="add-solid-color" class="btn btn-outline text-sm px-3 py-2">
                                        <i class="fas fa-plus mr-1"></i> Добавить
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Gradients -->
                        <div id="gradient-colors" class="color-options hidden mb-4">
                            <div class="grid grid-cols-4 gap-3 mb-3">
                                {% for color in colors %}
                                    {% if color.gradient_css %}
                                    <div class="color-option w-full h-10 rounded-lg cursor-pointer border-2 hover:border-blue-300 transition-all
                                                {% if color == selected_color and color.gradient_css %}border-blue-500 ring-2 ring-blue-200{% else %}border-transparent{% endif %}"
                                         style="background: {{ color.gradient_css }}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                         data-color-id="{{ color.id }}"
                                         data-color-type="gradient"
                                         data-color-value="{{ color.gradient_css }}"
                                         title="{{ color.name }}">
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <label class="block mb-2 text-sm font-medium text-gray-700">Создать градиент</label>
                                <div class="space-y-3">
                                    <div class="flex gap-2">
                                        <input type="color" id="gradient-color-1" value="#000000" class="flex-1 h-10 rounded-lg cursor-pointer border border-gray-300">
                                        <input type="color" id="gradient-color-2" value="#ffffff" class="flex-1 h-10 rounded-lg cursor-pointer border border-gray-300">
                                    </div>
                                    <select id="gradient-direction" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        <option value="to right">Горизонтальный</option>
                                        <option value="to bottom">Вертикальный</option>
                                        <option value="to bottom right">Диагональный</option>
                                    </select>
                                    <button id="add-gradient-color" class="btn btn-outline text-sm w-full py-2">
                                        <i class="fas fa-plus mr-1"></i> Добавить градиент
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Patterns -->
                        <div id="pattern-colors" class="color-options hidden mb-4">
                            <div class="grid grid-cols-4 gap-3 mb-3">
                                {% for color in colors %}
                                    {% if color.pattern_image %}
                                    <div class="color-option w-full h-10 rounded-lg cursor-pointer border-2 hover:border-blue-300 transition-all
                                                {% if color == selected_color and color.pattern_image %}border-blue-500 ring-2 ring-blue-200{% else %}border-transparent{% endif %}"
                                         style="background-image: url('{{ color.pattern_image.url }}'); background-size: cover; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                         data-color-id="{{ color.id }}"
                                         data-color-type="pattern"
                                         data-color-value="url('{{ color.pattern_image.url }}')"
                                         title="{{ color.name }}">
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                <label class="block mb-2 text-sm font-medium text-gray-700">Добавить текстуру</label>
                                <div class="flex gap-2">
                                    <label for="custom-pattern" class="cursor-pointer bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 px-3 rounded-lg border border-gray-300 text-sm font-medium transition-colors flex-1 truncate">
                                        <i class="fas fa-upload mr-1"></i>Выбрать файл
                                    </label>
                                    <input type="file" id="custom-pattern" accept="image/*" class="hidden">
                                    <button id="add-pattern" class="btn btn-outline text-sm px-3 py-2">
                                        <i class="fas fa-plus mr-1"></i> Добавить
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4">
                            <label class="block mb-2 text-sm font-medium text-gray-700">Текущий цвет:</label>
                            <div id="color-preview" class="w-full h-12 rounded-lg border border-gray-300 shadow-inner flex items-center justify-center"
                                 style="{% if selected_color.gradient_css %}background: {{ selected_color.gradient_css }};
                                        {% elif selected_color.pattern_image %}background-image: url('{{ selected_color.pattern_image.url }}'); background-size: cover;
                                        {% else %}background-color: {{ selected_color.hex_code }}{% endif %}">
                                <span class="text-xs font-medium bg-white bg-opacity-80 px-2 py-1 rounded-full">
                                    {% if selected_color.gradient_css %}Градиент
                                    {% elif selected_color.pattern_image %}Текстура
                                    {% else %}Цвет #{{ selected_color.hex_code|cut:'#' }}
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Size -->
                    <div class="mb-4">
                        <label class="block mb-2 text-sm font-medium text-gray-700">Размер</label>
                        <select id="product-size" class="w-full border border-gray-300 rounded-lg px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            {% for size in sizes %}
                                <option value="{{ size }}">{{ size }}</option>
                            {% empty %}
                                <option value="one-size">Один размер</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Quantity -->
                    <div class="mb-6">
                        <label class="block mb-2 text-sm font-medium text-gray-700">Количество</label>
                        <div class="flex items-center border border-gray-300 rounded-lg overflow-hidden w-32">
                            <button class="decrement-btn bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 transition-colors">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="product-quantity" min="1" value="1" class="w-full text-center border-0 focus:ring-0">
                            <button class="increment-btn bg-gray-100 hover:bg-gray-200 text-gray-800 px-3 py-2 transition-colors">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    {% if preview_mode %}
                        <button id="back-to-edit-btn" class="btn btn-outline mb-3 w-full py-3">
                            <i class="fas fa-edit mr-2"></i>Вернуться к редактированию
                        </button>
                        <button id="save-order-btn" class="btn btn-primary w-full py-3 shadow-lg hover:shadow-xl transition-shadow">
                            <i class=""></i>Добавить в корзину
                        </button>
                    {% else %}
                        <button id="preview-btn" class="btn btn-outline mb-3 w-full py-3">
                            <i class=""></i>Предпросмотр
                        </button>
                        <button id="save-order-btn" class="btn btn-primary w-full py-3 shadow-lg hover:shadow-xl transition-shadow">
                            <i class=""></i>Добавить в корзину
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentElement = null;
    let currentSide = 'front';
    let currentColor = null;
    const designId = {{ design.id }};
    const designContainer = document.getElementById('design-container');
    const frontElementsContainer = document.getElementById('front-elements-container');
    const backElementsContainer = document.getElementById('back-elements-container');
    const previewMode = {% if preview_mode %}true{% else %}false{% endif %};

        initColorOverlay();

        // ВСТАВЬТЕ КОД ЗДЕСЬ (начало)
    // Проверяем, есть ли сохраненный цвет в localStorage
    const savedColor = localStorage.getItem('lastSelectedColor');
    if (savedColor) {
        currentColor = JSON.parse(savedColor);

        // Находим соответствующий элемент цвета и применяем его
        const colorOption = document.querySelector(`.color-option[data-color-id="${currentColor.id}"]`);
        if (colorOption) {
            colorOption.click(); // Имитируем клик для применения цвета
        }
    }

    // Initialize color overlay
   function initColorOverlay() {
    // Remove any existing overlay
    const existingOverlay = document.getElementById('color-overlay');
    if (existingOverlay) existingOverlay.remove();

    // Check if we have a selected color from the backend
    const selectedColor = {% if selected_color %}{
        id: '{{ selected_color.id }}',
        type: '{% if selected_color.gradient_css %}gradient{% elif selected_color.pattern_image %}pattern{% else %}solid{% endif %}',
        value: '{% if selected_color.gradient_css %}{{ selected_color.gradient_css }}{% elif selected_color.pattern_image %}url(\'{{ selected_color.pattern_image.url }}\'){% else %}{{ selected_color.hex_code }}{% endif %}'
    }{% else %}null{% endif %};

    // Apply the color immediately
    if (selectedColor) {
        currentColor = selectedColor;
        applyColorToProduct(selectedColor.value, selectedColor.type);

        // Mark the color as selected in the UI
        const colorOption = document.querySelector(`.color-option[data-color-id="${selectedColor.id}"]`);
        if (colorOption) {
            colorOption.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');
            colorOption.classList.remove('border-transparent');

            // Switch to the correct color type tab
            const colorType = selectedColor.type;
            document.querySelectorAll('.color-type-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline');
            });
            document.querySelector(`.color-type-btn[data-type="${colorType}"]`).classList.remove('btn-outline');
            document.querySelector(`.color-type-btn[data-type="${colorType}"]`).classList.add('btn-primary');

            document.querySelectorAll('.color-options').forEach(opt => {
                opt.classList.add('hidden');
            });
            document.getElementById(`${colorType}-colors`).classList.remove('hidden');
        }
    } else {
        // If no color is selected, use the first available
        const firstColor = document.querySelector('.color-option');
        if (firstColor) {
            firstColor.click(); // Trigger click to apply the color
        }
    }
}

    // Front/back buttons
    document.getElementById('front-btn')?.addEventListener('click', function() {
        {% if front_image %}
        document.getElementById('product-image').src = '{{ front_image.image.url }}';
        {% endif %}
        frontElementsContainer.classList.remove('hidden');
        if (backElementsContainer) backElementsContainer.classList.add('hidden');
        this.classList.add('btn-primary');
        this.classList.remove('btn-outline');
        document.getElementById('back-btn')?.classList.remove('btn-primary');
        document.getElementById('back-btn')?.classList.add('btn-outline');
        currentSide = 'front';

        // Apply current color without reload
        if (currentColor) {
            applyColorToProduct(currentColor.value, currentColor.type);
        }
    });

    {% if back_image %}
    document.getElementById('back-btn')?.addEventListener('click', function() {
        document.getElementById('product-image').src = '{{ back_image.image.url }}';
        frontElementsContainer.classList.add('hidden');
        backElementsContainer.classList.remove('hidden');
        this.classList.add('btn-primary');
        this.classList.remove('btn-outline');
        document.getElementById('front-btn')?.classList.remove('btn-primary');
        document.getElementById('front-btn')?.classList.add('btn-outline');
        currentSide = 'back';

        // Apply current color without reload
        if (currentColor) {
            applyColorToProduct(currentColor.value, currentColor.type);
        }
    });
    {% endif %}

    // Apply color to product with mask for current side
// Функция applyColorToProduct должна корректно обрабатывать все типы цветов
function applyColorToProduct(colorValue, colorType) {
    const existingOverlay = document.getElementById('color-overlay');
    if (existingOverlay) existingOverlay.remove();

    const overlay = document.createElement('div');
    overlay.id = 'color-overlay';
    overlay.style.position = 'absolute';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.pointerEvents = 'none';
    overlay.style.mixBlendMode = 'multiply';
    overlay.style.zIndex = '5';

    {% if template.silhouette %}
        if (currentSide === 'front' && '{{ template.silhouette.front_mask_image.url }}') {
            overlay.style.maskImage = 'url({{ template.silhouette.front_mask_image.url }})';
            overlay.style.webkitMaskImage = 'url({{ template.silhouette.front_mask_image.url }})';
        } else if (currentSide === 'back' && '{{ template.silhouette.back_mask_image.url }}') {
            overlay.style.maskImage = 'url({{ template.silhouette.back_mask_image.url }})';
            overlay.style.webkitMaskImage = 'url({{ template.silhouette.back_mask_image.url }})';
        }
        overlay.style.maskSize = '100% 100%';
        overlay.style.maskRepeat = 'no-repeat';
        overlay.style.maskMode = 'luminance';
        overlay.style.webkitMaskSize = '100% 100%';
        overlay.style.webkitMaskRepeat = 'no-repeat';
        overlay.style.webkitMaskMode = 'luminance';
    {% endif %}

    if (colorType === 'solid') {
        overlay.style.backgroundColor = colorValue;
        overlay.style.backgroundImage = 'none';
    } else if (colorType === 'gradient') {
        overlay.style.background = colorValue;
    } else if (colorType === 'pattern') {
        overlay.style.backgroundImage = colorValue;
        overlay.style.backgroundSize = 'cover';
    }

    const productImage = document.getElementById('product-image');
    if (productImage) {
        productImage.style.zIndex = '1';
        productImage.parentNode.insertBefore(overlay, productImage.nextSibling);
    } else {
        designContainer.insertBefore(overlay, designContainer.firstChild);
    }
}

    // Initialize color overlay on page load
    initColorOverlay();

    // Load Font Awesome
    const faScript = document.createElement('script');
    faScript.src = 'https://kit.fontawesome.com/a076d05399.js';
    faScript.crossOrigin = 'anonymous';
    document.head.appendChild(faScript);

    if (!previewMode) {
        // Add new text element
        document.getElementById('add-text-btn').addEventListener('click', function() {
            const container = currentSide === 'front' ? frontElementsContainer : backElementsContainer;

            const newElement = document.createElement('div');
            newElement.className = 'user-element absolute border-2 border-blue-500 p-2 cursor-move';
            newElement.style.width = '200px';
            newElement.style.height = '50px';
            newElement.style.left = '100px';
            newElement.style.top = '100px';
             newElement.style.transformOrigin = 'center center';
            newElement.dataset.side = currentSide;
            newElement.innerHTML = `
                <div class="element-content h-full w-full flex items-center justify-center">
                    <span style="color: #000000; font-size: 14px; width: 100%; text-align: center; display: flex; align-items: center; justify-content: center;">Новый текст</span>
                </div>
                <div class="element-controls absolute -top-3 -right-3 flex gap-1">
                    <button class="resize-handle w-4 h-4 bg-blue-500 rounded-full cursor-nwse-resize flex items-center justify-center">
                        <i class="fas fa-expand-alt text-white" style="font-size: 8px;"></i>
                    </button>
                    <button class="rotate-handle w-4 h-4 bg-green-500 rounded-full cursor-grab flex items-center justify-center">
                        <i class="fas fa-redo text-white" style="font-size: 8px;"></i>
                    </button>
                </div>
            `;

            newElement.addEventListener('click', function(e) {
                if (e.target.classList.contains('resize-handle') || e.target.classList.contains('rotate-handle')) return;
                selectElement(newElement);
            });

            makeElementDraggable(newElement);
            makeElementResizable(newElement);
            makeElementRotatable(newElement);

            container.appendChild(newElement);
            selectElement(newElement);
        });

        // Add new image element
        document.getElementById('add-image-btn').addEventListener('click', function() {
            const container = currentSide === 'front' ? frontElementsContainer : backElementsContainer;

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const newElement = document.createElement('div');
                        newElement.className = 'user-element absolute border-2 border-blue-500 p-2 cursor-move';
                        newElement.style.width = '150px';
                        newElement.style.height = '150px';
                        newElement.style.left = '100px';
                        newElement.style.top = '100px';
                        newElement.dataset.side = currentSide;
                        newElement.dataset.tempImage = URL.createObjectURL(file);
                        newElement.innerHTML = `
                            <div class="element-content h-full w-full flex items-center justify-center">
                                <img src="${event.target.result}" class="max-w-full max-h-full" style="transform: rotate(0deg);">
                            </div>
                            <div class="element-controls absolute -top-3 -right-3 flex gap-1">
                                <button class="resize-handle w-4 h-4 bg-blue-500 rounded-full cursor-nwse-resize flex items-center justify-center">
                                    <i class="fas fa-expand-alt text-white" style="font-size: 8px;"></i>
                                </button>
                                <button class="rotate-handle w-4 h-4 bg-green-500 rounded-full cursor-grab flex items-center justify-center">
                                    <i class="fas fa-redo text-white" style="font-size: 8px;"></i>
                                </button>
                            </div>
                        `;

                        newElement.addEventListener('click', function(e) {
                            if (e.target.classList.contains('resize-handle') || e.target.classList.contains('rotate-handle')) return;
                            selectElement(newElement);
                        });

                        makeElementDraggable(newElement);
                        makeElementResizable(newElement);
                        makeElementRotatable(newElement);

                        container.appendChild(newElement);
                        selectElement(newElement);
                    };
                    reader.readAsDataURL(file);
                }
            };
            fileInput.click();
        });

// В функции selectElement обновим обработку вращения
function selectElement(element) {
    if (currentElement) {
        currentElement.classList.remove('border-blue-500');
        currentElement.classList.add('border-transparent');
    }

    currentElement = element;
    currentElement.classList.remove('border-transparent');
    currentElement.classList.add('border-blue-500');

    document.getElementById('element-controls').classList.remove('hidden');
    document.getElementById('product-controls').classList.add('hidden');

    const content = element.querySelector('.element-content');

      // Сохраняем оригинальные размеры при первом выборе элемента
    if (!element.dataset.originalWidth) {
        element.dataset.originalWidth = element.style.width;
        element.dataset.originalHeight = element.style.height;
        const span = content.querySelector('span');
        if (span) {
            span.dataset.originalFontSize = span.style.fontSize || '14px';
        }
    }

    // Получаем угол поворота контейнера
    let containerRotation = 0;
    if (element.style.transform) {
        const match = element.style.transform.match(/rotate\((\d+)deg\)/);
        if (match) containerRotation = parseInt(match[1]);
    }

    document.getElementById('element-rotation').value = containerRotation;
    document.getElementById('rotation-value').textContent = containerRotation + '°';

    if (content.querySelector('img')) {
        document.getElementById('element-text').closest('.mb-4').classList.add('hidden');
        document.getElementById('element-color').closest('.mb-4').classList.add('hidden');
        document.getElementById('element-font-size').closest('.mb-4').classList.add('hidden');
    } else if (content.querySelector('span')) {
        document.getElementById('element-text').closest('.mb-4').classList.remove('hidden');
        document.getElementById('element-color').closest('.mb-4').classList.remove('hidden');
        document.getElementById('element-font-size').closest('.mb-4').classList.remove('hidden');

        const span = content.querySelector('span');
        document.getElementById('element-text').value = span.textContent;
        document.getElementById('element-color').value = span.style.color || '#000000';

        let fontSize = span.style.fontSize || '14px';
        fontSize = parseInt(fontSize.replace('px', ''));
        document.getElementById('element-font-size').value = fontSize;
        document.getElementById('font-size-value').textContent = fontSize + 'px';
    }
}


        // Make element draggable
function makeElementDraggable(element) {
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    element.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('resize-handle') ||
            e.target.classList.contains('rotate-handle')) {
            return;
        }

        e.preventDefault();
        isDragging = true;

        // Получаем текущие координаты элемента с учетом трансформаций
        const rect = element.getBoundingClientRect();
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseInt(element.style.left) || 0;
        startTop = parseInt(element.style.top) || 0;

        // Добавляем класс для визуальной обратной связи
        element.classList.add('dragging');

        // Улучшаем курсор при перетаскивании
        document.body.style.cursor = 'grabbing';
        document.body.style.userSelect = 'none';
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;

        e.preventDefault();

        // Рассчитываем новые координаты
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;

        let newLeft = startLeft + dx;
        let newTop = startTop + dy;

        // Ограничиваем перемещение границами контейнера
        const containerRect = designContainer.getBoundingClientRect();
        const elementRect = element.getBoundingClientRect();

        newLeft = Math.max(0, Math.min(newLeft, containerRect.width - elementRect.width));
        newTop = Math.max(0, Math.min(newTop, containerRect.height - elementRect.height));

        // Применяем новые координаты
        element.style.left = newLeft + 'px';
        element.style.top = newTop + 'px';
    });

    document.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            element.classList.remove('dragging');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        }
    });
}

      // В функции makeElementResizable добавим проверку на тип элемента
function makeElementResizable(element) {
    const resizeHandle = element.querySelector('.resize-handle');
    // Если это текстовый элемент - скрываем handle
    if (element.querySelector('.element-content span')) {
        resizeHandle.style.display = 'none';
        return;
    }

    let startX, startY, startWidth, startHeight;

    resizeHandle.onmousedown = function(e) {
        e.preventDefault();
        startX = e.clientX;
        startY = e.clientY;
        startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
        startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
        document.onmousemove = resizeElement;
        document.onmouseup = stopResize;
    };

    function resizeElement(e) {
        const width = startWidth + (e.clientX - startX);
        const height = startHeight + (e.clientY - startY);

        if (width > 50) element.style.width = width + 'px';
        if (height > 20) element.style.height = height + 'px';

        const content = element.querySelector('.element-content');
        if (content && content.querySelector('img')) {
            const img = content.querySelector('img');
            // Для изображений сохраняем пропорции
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
        }
    }

    function stopResize() {
        document.onmousemove = null;
        document.onmouseup = null;
    }
}

// В функции makeElementRotatable аналогично добавим проверку
function makeElementRotatable(element) {
    const rotateHandle = element.querySelector('.rotate-handle');
    // Если это текстовый элемент - скрываем handle
    if (element.querySelector('.element-content span')) {
        rotateHandle.style.display = 'none';
        return;
    }

    let startAngle = 0;
    let initialAngle = 0;
    let centerX, centerY;

    rotateHandle.onmousedown = function(e) {
        e.preventDefault();
        e.stopPropagation();

        const rect = element.getBoundingClientRect();
        centerX = rect.left + rect.width / 2;
        centerY = rect.top + rect.height / 2;

        if (element.style.transform) {
            const match = element.style.transform.match(/rotate\((\d+)deg\)/);
            if (match) initialAngle = parseInt(match[1]);
        }

        startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;

        document.onmousemove = rotateElement;
        document.onmouseup = stopRotate;
    };

    function rotateElement(e) {
        const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * 180 / Math.PI;
        const rotation = (initialAngle + angle - startAngle) % 360;
        element.style.transform = `rotate(${rotation}deg)`;
        document.getElementById('element-rotation').value = rotation;
        document.getElementById('rotation-value').textContent = rotation + '°';
    }

    function stopRotate() {
        document.onmousemove = null;
        document.onmouseup = null;
    }
}



        // Save element - improved version with all properties
        // Save element - improved version with all properties
// Save element - improved version with all properties
document.getElementById('save-element-btn').addEventListener('click', function() {
    if (!currentElement) return;

    const content = currentElement.querySelector('.element-content');
    const textContent = document.getElementById('element-text').value;
    const color = document.getElementById('element-color').value;
    const fontSize = document.getElementById('element-font-size').value;
    const rotation = parseInt(document.getElementById('element-rotation').value);
    const imageInput = document.getElementById('element-image');
    const side = currentSide;
    const areaId = currentElement.dataset.areaId || null;
    const elementId = currentElement.dataset.elementId || null;
    const tempImageUrl = currentElement.dataset.tempImage;
    const xPosition = parseInt(currentElement.style.left) || 0;
    const yPosition = parseInt(currentElement.style.top) || 0;
    const width = parseInt(currentElement.style.width) || 150;
    const height = parseInt(currentElement.style.height) || 50;

    const formData = new FormData();
    formData.append('design_id', designId);
    formData.append('x_position', xPosition);
    formData.append('y_position', yPosition);
    formData.append('width', width);
    formData.append('height', height);
    formData.append('rotation', rotation);
    formData.append('side', side);

    if (elementId) formData.append('element_id', elementId);
    if (areaId) formData.append('area_id', areaId);

    // Сохраняем текущий цвет в сессии перед отправкой формы
    if (currentColor) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch('{% url "designer:save_selected_color" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': csrfToken
            },
            body: `color_id=${currentColor.id}`
        }).then(() => {
            // После сохранения цвета продолжаем сохранение элемента
            continueSavingElement();
        });
    } else {
        continueSavingElement();
    }

    function continueSavingElement() {
        if (tempImageUrl || (imageInput && imageInput.files.length > 0) || content.querySelector('img')) {
            if (tempImageUrl) {
                fetch(tempImageUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'uploaded_image.png', { type: blob.type });
                        formData.append('image', file);
                        sendFormData(formData);
                    });
            } else if (imageInput.files.length > 0) {
                formData.append('image', imageInput.files[0]);
                sendFormData(formData);
            } else {
                formData.append('update_existing', 'true');
                sendFormData(formData);
            }
        } else if (textContent) {
            formData.append('text_content', textContent);
            formData.append('color', color);
            formData.append('font_size', fontSize);
            sendFormData(formData);
        }
    }

    function sendFormData(formData) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        fetch('{% url "designer:save_custom_element" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // После успешного сохранения элемента обновляем страницу
                // и сохраняем текущий цвет в localStorage
                if (currentColor) {
                    localStorage.setItem('lastSelectedColor', JSON.stringify(currentColor));
                }
                window.location.reload();
            } else {
                throw new Error(data.message || 'Ошибка сервера');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при сохранении: ' + error.message);
        });
    }
});

// При загрузке страницы восстанавливаем последний выбранный цвет
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем, есть ли сохраненный цвет в localStorage
    const savedColor = localStorage.getItem('lastSelectedColor');
    if (savedColor) {
        currentColor = JSON.parse(savedColor);

        // Находим соответствующий элемент цвета и применяем его
        const colorOption = document.querySelector(`.color-option[data-color-id="${currentColor.id}"]`);
        if (colorOption) {
            colorOption.click(); // Имитируем клик для применения цвета
        }
    }
});

        // Handle click on saved element or empty area
// В функции handleElementClick сохраняем угол поворота при создании временного элемента
function handleElementClick(e) {
    const elementDisplay = e.currentTarget;
    const elementId = elementDisplay.dataset.elementId;
    const areaId = elementDisplay.dataset.areaId || elementDisplay.closest('.design-area').dataset.areaId;
    const side = elementDisplay.closest('#front-elements-container') ? 'front' : 'back';

    // Получаем угол поворота из элемента
    let rotation = 0;
    if (elementDisplay.style.transform) {
        const match = elementDisplay.style.transform.match(/rotate\((\d+)deg\)/);
        if (match) rotation = parseInt(match[1]);
    }

    const areaElement = elementDisplay.closest('.design-area');
    if (areaElement) {
        areaElement.remove();

        const tempElement = document.createElement('div');
        tempElement.className = 'user-element absolute border-2 border-blue-500 p-2 cursor-move';
        tempElement.style.left = areaElement.style.left;
        tempElement.style.top = areaElement.style.top;
        tempElement.style.width = areaElement.style.width;
        tempElement.style.height = areaElement.style.height;
        tempElement.style.transform = `rotate(${rotation}deg)`;
        tempElement.dataset.elementId = elementId || '';
        tempElement.dataset.areaId = areaId;
        tempElement.dataset.side = side;

        if (!elementId) {
            tempElement.innerHTML = `
                <div class="element-content h-full w-full flex items-center justify-center">
                    <span style="color: #000000; font-size: 14px; width: 100%; text-align: center; display: flex; align-items: center; justify-content: center;">Новый текст</span>
                </div>
                <div class="element-controls absolute -top-3 -right-3 flex gap-1">
                    <button class="resize-handle w-4 h-4 bg-blue-500 rounded-full cursor-nwse-resize flex items-center justify-center">
                        <i class="fas fa-expand-alt text-white" style="font-size: 8px;"></i>
                    </button>
                    <button class="rotate-handle w-4 h-4 bg-green-500 rounded-full cursor-grab flex items-center justify-center">
                        <i class="fas fa-redo text-white" style="font-size: 8px;"></i>
                    </button>
                </div>
            `;
        } else if (elementDisplay.tagName === 'IMG') {
            tempElement.innerHTML = `
                <div class="element-content h-full w-full flex items-center justify-center">
                    <img src="${elementDisplay.src}" class="max-w-full max-h-full" style="transform: none;">
                </div>
                <div class="element-controls absolute -top-3 -right-3 flex gap-1">
                    <button class="resize-handle w-4 h-4 bg-blue-500 rounded-full cursor-nwse-resize flex items-center justify-center">
                        <i class="fas fa-expand-alt text-white" style="font-size: 8px;"></i>
                    </button>
                    <button class="rotate-handle w-4 h-4 bg-green-500 rounded-full cursor-grab flex items-center justify-center">
                        <i class="fas fa-redo text-white" style="font-size: 8px;"></i>
                    </button>
                </div>
            `;
        } else {
            const style = elementDisplay.getAttribute('style') || '';
            tempElement.innerHTML = `
                <div class="element-content h-full w-full flex items-center justify-center">
                    <span style="${style.replace(/transform:[^;]*;?/g, '')}">${elementDisplay.textContent}</span>
                </div>
                <div class="element-controls absolute -top-3 -right-3 flex gap-1">
                    <button class="resize-handle w-4 h-4 bg-blue-500 rounded-full cursor-nwse-resize flex items-center justify-center">
                        <i class="fas fa-expand-alt text-white" style="font-size: 8px;"></i>
                    </button>
                    <button class="rotate-handle w-4 h-4 bg-green-500 rounded-full cursor-grab flex items-center justify-center">
                        <i class="fas fa-redo text-white" style="font-size: 8px;"></i>
                    </button>
                </div>
            `;
        }

        const container = side === 'front' ? frontElementsContainer : backElementsContainer;
        container.appendChild(tempElement);

        makeElementDraggable(tempElement);
        makeElementResizable(tempElement);
        makeElementRotatable(tempElement);
        selectElement(tempElement);

        currentElement = tempElement;
    }
}


        // Delete element
        document.getElementById('delete-element-btn').addEventListener('click', function() {
            if (!currentElement) return;

            if (confirm('Удалить этот элемент?')) {
                if (currentElement.dataset.elementId) {
                    fetch('{% url "designer:delete_custom_element" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: `element_id=${currentElement.dataset.elementId}`
                    }).then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            currentElement.remove();
                            currentElement = null;
                            document.getElementById('element-controls').classList.add('hidden');
                            document.getElementById('product-controls').classList.remove('hidden');
                        }
                    });
                } else {
                    currentElement.remove();
                    currentElement = null;
                    document.getElementById('element-controls').classList.add('hidden');
                    document.getElementById('product-controls').classList.remove('hidden');
                }
            }
        });

        // Cancel editing
        document.getElementById('cancel-edit-btn').addEventListener('click', function() {
            if (currentElement) {
                if (currentElement.dataset.elementId) {
                    const side = currentElement.dataset.side || 'front';
                    const container = side === 'front' ? frontElementsContainer : backElementsContainer;

                    const savedElement = document.createElement('div');
                    savedElement.className = 'design-area absolute p-0';
                    savedElement.style.left = currentElement.style.left;
                    savedElement.style.top = currentElement.style.top;
                    savedElement.style.width = currentElement.style.width;
                    savedElement.style.height = currentElement.style.height;
                    savedElement.dataset.areaId = currentElement.dataset.areaId;
                    savedElement.dataset.elementId = currentElement.dataset.elementId;

                    const content = currentElement.querySelector('.element-content');
                    if (content.querySelector('img')) {
                        const img = content.querySelector('img');
                        const rotation = img.style.transform ? img.style.transform.match(/rotate\((\d+)deg\)/)[1] : 0;
                        savedElement.innerHTML = `
                            <div class="area-content h-full w-full flex items-center justify-center">
                                <img src="${img.src}" class="max-w-full max-h-full element-display"
                                     data-element-id="${currentElement.dataset.elementId}"
                                     data-area-id="${currentElement.dataset.areaId}"
                                     style="transform: rotate(${rotation}deg);">
                            </div>
                        `;
                    } else {
                        const span = content.querySelector('span');
                        savedElement.innerHTML = `
                            <div class="area-content h-full w-full flex items-center justify-center">
                                <span class="element-display"
                                      style="${span.getAttribute('style')}"
                                      data-element-id="${currentElement.dataset.elementId}"
                                      data-area-id="${currentElement.dataset.areaId}">
                                    ${span.textContent}
                                </span>
                            </div>
                        `;
                    }

                    container.appendChild(savedElement);
                    const displayElement = savedElement.querySelector('.element-display');
                    displayElement.addEventListener('click', handleElementClick);

                    currentElement.remove();
                    currentElement = null;
                }
            }
            document.getElementById('element-controls').classList.add('hidden');
            document.getElementById('product-controls').classList.remove('hidden');
        });

        // Enable editing for all elements on page load
        document.querySelectorAll('.element-display').forEach(element => {
            element.addEventListener('click', handleElementClick);
        });
    }

    // Color selection
    document.querySelectorAll('.color-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.remove('border-blue-500', 'ring-2', 'ring-blue-200');
                opt.classList.add('border-transparent');
            });
            this.classList.add('border-blue-500', 'ring-2', 'ring-blue-200');
            this.classList.remove('border-transparent');

            // Сохраняем текущий цвет в переменной
            currentColor = {
                id: this.dataset.colorId,
                type: this.dataset.colorType,
                value: this.dataset.colorValue
            };

            // Update preview
            const preview = document.getElementById('color-preview');
            if (currentColor.type === 'solid') {
                preview.style.background = currentColor.value;
                preview.style.backgroundImage = 'none';
                preview.querySelector('span').textContent = `Цвет ${currentColor.value}`;
            } else if (currentColor.type === 'gradient') {
                preview.style.background = currentColor.value;
                preview.querySelector('span').textContent = 'Градиент';
            } else if (currentColor.type === 'pattern') {
                preview.style.backgroundImage = currentColor.value;
                preview.style.backgroundSize = 'cover';
                preview.querySelector('span').textContent = 'Текстура';
            }

            // Apply color to product immediately
            applyColorToProduct(currentColor.value, currentColor.type);

            // Save selected color
            if (!previewMode) {
                fetch('{% url "designer:save_selected_color" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: `color_id=${currentColor.id}`
                });
            }
        });
    });

    // Color type switching
    document.querySelectorAll('.color-type-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.color-type-btn').forEach(b => {
                b.classList.remove('btn-primary');
                b.classList.add('btn-outline');
            });
            this.classList.remove('btn-outline');
            this.classList.add('btn-primary');

            document.querySelectorAll('.color-options').forEach(opt => {
                opt.classList.add('hidden');
            });

            const type = this.dataset.type;
            document.getElementById(`${type}-colors`).classList.remove('hidden');
        });
    });

    // Add solid color handler
    document.getElementById('add-solid-color')?.addEventListener('click', function() {
        const colorValue = document.getElementById('custom-solid-color').value;

        if (!colorValue) {
            alert('Пожалуйста, выберите цвет');
            return;
        }

        const formData = new FormData();
        formData.append('type', 'solid');
        formData.append('value', colorValue);
        formData.append('name', `Custom Color ${colorValue}`);

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch('{% url "designer:add_custom_color" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('Ошибка при добавлении цвета: ' + (data.message || 'Неизвестная ошибка'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при добавлении цвета: ' + error.message);
        });
    });

    // Add gradient color
    document.getElementById('add-gradient-color')?.addEventListener('click', function() {
        const color1 = document.getElementById('gradient-color-1').value;
        const color2 = document.getElementById('gradient-color-2').value;
        const direction = document.getElementById('gradient-direction').value;

        const gradientValue = `linear-gradient(${direction}, ${color1}, ${color2})`;

        const formData = new FormData();
        formData.append('type', 'gradient');
        formData.append('value', gradientValue);
        formData.append('name', `Custom Gradient ${Date.now()}`);

        fetch('{% url "designer:add_custom_color" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        }).then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('Ошибка при сохранении градиента: ' + (data.message || 'Неизвестная ошибка'));
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Ошибка при сохранении градиента');
        });
    });

    // Add pattern texture
    document.getElementById('add-pattern')?.addEventListener('click', function() {
        const fileInput = document.getElementById('custom-pattern');
        if (fileInput.files.length === 0) {
            alert('Пожалуйста, выберите файл текстуры');
            return;
        }

        const formData = new FormData();
        formData.append('type', 'pattern');
        formData.append('image', fileInput.files[0]);
        formData.append('name', `Custom Pattern ${Date.now()}`);

        fetch('{% url "designer:add_custom_color" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: formData
        }).then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                window.location.reload();
            } else {
                alert('Ошибка при сохранении текстуры: ' + (data.message || 'Неизвестная ошибка'));
            }
        }).catch(error => {
            console.error('Error:', error);
            alert('Ошибка при сохранении текстуры');
        });
    });

    // Font size slider
// Font size slider - модифицированная версия
// Font size slider - модифицированная версия
// Font size slider - исправленная версия
document.getElementById('element-font-size')?.addEventListener('input', function() {
    const fontSize = parseInt(this.value);
    document.getElementById('font-size-value').textContent = fontSize + 'px';

    if (currentElement) {
        const span = currentElement.querySelector('.element-content span');
        if (span) {
            // Сохраняем оригинальные размеры при первом изменении
            if (!currentElement.dataset.originalWidth) {
                currentElement.dataset.originalWidth = currentElement.style.width || '200px';
                currentElement.dataset.originalHeight = currentElement.style.height || '50px';
                span.dataset.originalFontSize = span.style.fontSize || '14px';
            }

            // Устанавливаем новый размер шрифта
            span.style.fontSize = fontSize + 'px';

            // Создаем временный элемент для измерения текста
            const tempSpan = document.createElement('span');
            tempSpan.style.fontSize = fontSize + 'px';
            tempSpan.style.fontFamily = window.getComputedStyle(span).fontFamily;
            tempSpan.style.whiteSpace = 'nowrap'; // Запрещаем перенос строк
            tempSpan.style.visibility = 'hidden';
            tempSpan.style.position = 'absolute';
            tempSpan.style.left = '-9999px';
            tempSpan.textContent = span.textContent;

            document.body.appendChild(tempSpan);

            // Получаем реальные размеры текста
            const textWidth = Math.max(tempSpan.offsetWidth + 20, 50); // Минимальная ширина 50px
            const textHeight = tempSpan.offsetHeight + 10;

            document.body.removeChild(tempSpan);

            // Устанавливаем размеры контейнера
            currentElement.style.width = textWidth + 'px';
            currentElement.style.height = textHeight + 'px';

            // Гарантируем, что текст всегда виден
            span.style.whiteSpace = 'nowrap';
            span.style.overflow = 'visible';
            span.style.display = 'flex';
            span.style.alignItems = 'center';
            span.style.justifyContent = 'center';
            span.style.width = '100%';
            span.style.height = '100%';
            span.style.textAlign = 'center';
        }
    }
});

    // Rotation slider
document.getElementById('element-rotation')?.addEventListener('input', function() {
    const intValue = parseInt(this.value);
    document.getElementById('rotation-value').textContent = intValue + '°';
    if (currentElement) {
        // Применяем вращение только к контейнеру
        currentElement.style.transform = `rotate(${intValue}deg)`;

        // Сбрасываем вращение внутреннего элемента
        const content = currentElement.querySelector('.element-content');
        if (content) {
            const child = content.querySelector('img') || content.querySelector('span');
            if (child) {
                child.style.transform = 'none';
            }
        }
    }
});

    // Отображение имени загружаемого файла
    document.getElementById('element-image')?.addEventListener('change', function() {
        if (this.files.length > 0) {
            document.getElementById('image-filename').textContent = this.files[0].name;
        }
    });

    document.getElementById('custom-pattern')?.addEventListener('change', function() {
        if (this.files.length > 0) {
            const label = document.querySelector('label[for="custom-pattern"]');
            label.innerHTML = `<i class="fas fa-file-image mr-1"></i>${this.files[0].name.substring(0, 10)}...`;
        }
    });

    // Preview and save buttons
    document.getElementById('preview-btn')?.addEventListener('click', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const sizesParam = urlParams.get('sizes');

        let previewUrl = '{% url "designer:preview_custom_design" design.id %}';
        if (sizesParam) {
            previewUrl += `?sizes=${encodeURIComponent(sizesParam)}`;
        }

        window.location.href = previewUrl;
    });

    document.getElementById('save-order-btn')?.addEventListener('click', function() {
        const colorId = document.querySelector('.color-option.border-blue-500')?.dataset.colorId;
        const size = document.getElementById('product-size').value;
        const quantity = document.getElementById('product-quantity').value;

        const urlParams = new URLSearchParams(window.location.search);
        const from_cart = urlParams.get('from_cart');
        const originalProductId = urlParams.get('product_id');
        const sizes = urlParams.get('sizes');

        fetch('{% url "designer:save_custom_design_order" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: `design_id=${designId}&color_id=${colorId}&size=${encodeURIComponent(size)}&quantity=${quantity}&original_product_id=${originalProductId}`
        }).then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (from_cart) {
                    window.location.href = '{% url "main:cart_view" %}';
                } else {
                    window.location.href = data.redirect_url || '{% url "main:cart_view" %}';
                }
            } else {
                alert(data.message || 'Ошибка при сохранении заказа');
            }
        });
    });

    // Quantity management
    document.querySelector('.increment-btn')?.addEventListener('click', function() {
        const input = document.getElementById('product-quantity');
        input.value = parseInt(input.value) + 1;
    });

    document.querySelector('.decrement-btn')?.addEventListener('click', function() {
        const input = document.getElementById('product-quantity');
        if (parseInt(input.value) > 1) {
            input.value = parseInt(input.value) - 1;
        }
    });

    // Back to cart button
    document.getElementById('back-to-cart-btn')?.addEventListener('click', function() {
        window.location.href = '{% url "main:cart_view" %}';
    });

    // Color hex value display
    document.getElementById('element-color')?.addEventListener('input', function() {
        document.getElementById('color-hex-value').textContent = this.value;
    });
    // Back to edit button - только в режиме предпросмотра
    if (previewMode) {
        document.getElementById('back-to-edit-btn')?.addEventListener('click', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const sizesParam = urlParams.get('sizes');
            const fromCart = urlParams.get('from_cart');

            let editUrl = '{% url "designer:custom_designer_edit" design.id %}';

            // Сохраняем параметры URL при переходе назад
            if (sizesParam) {
                editUrl += `?sizes=${encodeURIComponent(sizesParam)}`;
                if (fromCart) {
                    editUrl += `&from_cart=${fromCart}`;
                }
            } else if (fromCart) {
                editUrl += `?from_cart=${fromCart}`;
            }

            window.location.href = editUrl;
        });
    }
});

</script>

<style>

.design-area {
    background-color: transparent;
    cursor: pointer;
    border: none !important;
    padding: 0 !important;
    z-index: 10; /* Элементы поверх цветного слоя */
}

.element-content img {
    mix-blend-mode: normal !important; /* Отключаем наложение цвета для изображений */
    position: relative;
    z-index: 10;
}

#color-overlay {
    z-index: 5; /* Цветной слой между изображением товара и элементами */
    /* остальные свойства остаются без изменений */
}

#product-image {
    z-index: 1; /* Изображение товара - самый нижний слой */
    position: relative;
}
.user-element {
    transform-origin: center center;
    transition: transform 0.1s ease;
}

.element-content {
    pointer-events: none;
}

.element-content span, .element-content img {
    pointer-events: auto;
}
.btn {
    padding: 0.5rem 1rem;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-primary {
    background-color: #3b82f6;
    color: white;
    border: none;
}
.btn-outline {
    background-color: white;
    color: #3b82f6;
    border: 1px solid #3b82f6;
}
.btn-danger {
    background-color: #ef4444;
    color: white;
    border: none;
}
.btn.active {
    background-color: #2563eb;
}
.design-area {
    background-color: transparent;
    cursor: pointer;
    border: none !important;
    padding: 0 !important;
}
.user-element {
        will-change: transform;
    background-color: transparent;
    z-index: 10;
    border: 2px dashed blue !important;
        transition: all 0.2s ease;
    box-sizing: border-box;

}
.user-element:hover {
    background-color: rgba(219, 234, 254, 0.3);
}
.color-option:hover {
    transform: scale(1.1);
}
.element-controls {
    display: none;
    z-index: 20;
}
.user-element:hover .element-controls {
    display: flex;
}
.element-display {
    cursor: pointer;
}
.element-display:hover {
    outline: 1px dashed #ccc;
}
.area-content, .element-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.resize-handle {
    cursor: nwse-resize;
}
.rotate-handle {
    cursor: grab;
}
.element-content span {
    width: 100%;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    word-break: keep-all; /* Запрещаем перенос слов */
    white-space: nowrap; /* Запрещаем перенос строк */
    overflow: visible; /* Гарантируем, что текст всегда виден */
    transition: all 0.2s ease;
}
#color-overlay {
    z-index: 5;
    mask-image: inherit;
    mask-size: inherit;
    mask-repeat: inherit;
    mask-position: inherit;
    mask-mode: luminance;
    -webkit-mask-image: inherit;
    -webkit-mask-size: inherit;
    -webkit-mask-repeat: inherit;
    -webkit-mask-position: inherit;
    -webkit-mask-mode: luminance;
    mix-blend-mode: multiply;
    opacity: 0.9;
}
.color-options {
    transition: all 0.3s ease;
}
.color-type-btn.active {
    background-color: #3b82f6;
    color: white;
}
.color-preview {
    width: 100%;
    height: 40px;
    border-radius: 4px;
    margin-top: 8px;
    border: 1px solid #ddd;
}
.color-option {
    transition: transform 0.2s;
}
.color-option:hover {
    transform: scale(1.1);
}
.fas {
    pointer-events: none;
}
</style>
{% endblock %}