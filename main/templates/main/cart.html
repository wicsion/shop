{% extends "main/base.html" %}
{% load static i18n custom_filters %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">{% trans "Корзина" %}</h1>

    {% if cart_items or custom_items %}
    <div class="bg-white rounded-lg shadow overflow-hidden mb-8">
        <div class="divide-y divide-gray-200">
            <!-- Регулярные товары -->
            {% for cart_item in cart_items %}
            <div class="p-4 flex flex-col md:flex-row items-start md:items-center gap-4">
                <!-- Изображение товара -->
                <div class="w-48 h-48 flex-shrink-0 relative overflow-hidden rounded-lg shadow-sm border border-gray-200">
                    <div class="image-placeholder absolute inset-0"></div>
                    <img
                        src="{% static 'images/placeholder.jpg' %}"
                        data-src="{% url 'main:resize_image' %}?url={{ cart_item.image|urlencode }}&width=200&height=200"
                        alt="{{ cart_item.product.name }}"
                        class="lazy-load absolute inset-0 w-full h-full object-cover"
                        loading="lazy"
                    >
                </div>

                <div class="flex-1 flex flex-col md:flex-row md:items-center gap-4">
                    <div class="flex-1">
                        <a href="{{ cart_item.product.get_absolute_url }}"
                           class="font-semibold text-lg hover:text-blue-600 transition-colors"
                           title="{% trans 'Перейти к товару' %}">
                            {{ cart_item.product.name }}
                        </a>
                        <p class="text-gray-600">
                            {% if cart_item.product.categories.exists %}
                                {{ cart_item.product.categories.first.name }}
                            {% elif cart_item.product.brand %}
                                {{ cart_item.product.brand }}
                            {% endif %}
                        </p>

                        <!-- Отображение размера или предупреждения -->
                        {% if cart_item.size %}
                        <div class="mt-2">
                            <span class="font-medium text-gray-700">Размер:</span>
                            <span class="ml-2 px-3 py-1 bg-gray-100 rounded-full text-sm">{{ cart_item.size }}</span>
                        </div>
                        {% elif cart_item.selected_sizes %}
                        <div class="mt-2">
                            <span class="font-medium text-gray-700">Выбранные размеры:</span>
                            {% for size, quantity in cart_item.selected_sizes.items %}
                                <span class="ml-2 px-3 py-1 bg-gray-100 rounded-full text-sm">
                                    {{ size }} × {{ quantity }}
                                </span>
                            {% endfor %}
                        </div>
                        {% elif cart_item.product.has_variants %}
                        <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">
                                        Для этого товара не выбран размер.
                                        <a href="{% url 'main:select_sizes' cart_item.item.id %}" class="font-medium underline text-yellow-700 hover:text-yellow-600">
                                            Выберите размеры
                                        </a>
                                    </p>
                                    <p class="text-xs text-yellow-600 mt-1">
                                        Доступные размеры: {{ cart_item.product.get_available_sizes|join:", " }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <div class="flex flex-col sm:flex-row md:flex-col lg:flex-row items-end gap-4">
                        <div class="flex items-center">
                            <form action="{% url 'main:update_cart' cart_item.item.id %}" method="post" class="flex items-center">
                                {% csrf_token %}
                                <input type="number" name="quantity" value="{{ cart_item.item.quantity }}" min="1"
                                       class="border rounded px-3 py-1 w-20 text-center">
                                <button type="submit" class="ml-2 text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </form>
                        </div>

                        <div class="text-right">
                            <p class="font-bold">{{ cart_item.total_price }} ₽</p>
                            <a href="{% url 'main:remove_from_cart' cart_item.item.id %}"
                               class="text-red-600 hover:text-red-800 text-sm">
                                {% trans "Удалить" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Кастомные товары -->
            {% for custom_item in custom_items %}
            <div class="p-4 flex flex-col md:flex-row items-start md:items-center gap-4">
                <div class="w-48 h-48 flex-shrink-0 relative overflow-hidden rounded-lg shadow-sm border border-gray-200">
                    <div class="image-placeholder absolute inset-0"></div>
                    <img
                        src="{% static 'images/placeholder.jpg' %}"
                        data-src="{% if custom_item.original_product_info %}{% url 'main:resize_image' %}?url={{ custom_item.original_product_info.image|urlencode }}&width=200&height=200{% else %}{% url 'main:resize_image' %}?url={{ custom_item.design.template.images.first.image.url|urlencode }}&width=200&height=200{% endif %}"
                        alt="{% if custom_item.original_product_info %}{{ custom_item.original_product_info.name }}{% else %}Кастомный товар{% endif %}"
                        class="lazy-load absolute inset-0 w-full h-full object-cover"
                        loading="lazy"
                    >
                </div>

                <div class="flex-1 flex flex-col md:flex-row md:items-center gap-4">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg">
                            {% if custom_item.original_product_info %}
                                <a href="{{ custom_item.original_product_info.url }}" class="hover:text-blue-600 transition-colors">
                                    {{ custom_item.original_product_info.name }} + Кастомный дизайн
                                </a>
                            {% else %}
                                Кастомный {{ custom_item.design.template.name }}
                            {% endif %}
                        </h3>
                        <p class="text-gray-600">Ваш уникальный дизайн</p>

                        <!-- Размер -->
                        {% if custom_item.size %}
                        <div class="mt-2">
                            <span class="font-medium text-gray-700">Размер:</span>
                            <span class="ml-2 px-3 py-1 bg-gray-100 rounded-full text-sm">
                                {{ custom_item.size }}
                            </span>
                        </div>
                        {% endif %}
                    </div>

                    <div class="flex flex-col sm:flex-row md:flex-col lg:flex-row items-end gap-4">
                        <div class="flex items-center">
                            <form action="{% url 'designer:update_custom_item' custom_item.id %}" method="post" class="flex items-center">
                                {% csrf_token %}
                                <input type="number" name="quantity" value="{{ custom_item.quantity }}" min="1"
                                       class="border rounded px-3 py-1 w-20 text-center">
                                <button type="submit" class="ml-2 text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </form>
                        </div>

                    <!-- В блоке кастомных товаров, рядом с кнопкой удаления добавьте: -->
<!-- В блоке кастомных товаров, рядом с кнопкой удаления -->
<div class="text-right">
    <p class="font-bold">{{ custom_item.price }} ₽</p>
    <div class="flex gap-2 mt-1">
        <form action="{% url 'designer:remove_custom_item' custom_item.id %}" method="post" class="inline">
            {% csrf_token %}
            <button type="submit" class="text-red-600 hover:text-red-800 text-sm">
                {% trans "Удалить" %}
            </button>
        </form>
<a href="{% url 'designer:custom_designer_edit' custom_item.design.id %}?from_cart=true{% if custom_item.original_product %}&product_id={{ custom_item.original_product.product_id }}{% endif %}"
   class="text-blue-600 hover:text-blue-800 text-sm">
    {% trans "Редактировать дизайн" %}
</a>
    </div>
</div>
                        </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="p-4 bg-gray-50 border-t border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="font-semibold text-lg">{% trans "Итого" %}</h3>
                <p class="font-bold text-xl">{{ total_price }} ₽</p>
            </div>
        </div>
    </div>

    <div class="flex justify-end">
        {% if request.user.is_authenticated %}
            {% if has_missing_sizes %}
                <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-4 w-full">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-red-700">
                                Для оформления заказа необходимо выбрать размеры для всех товаров
                            </p>
                        </div>
                    </div>
                </div>
            {% else %}
                <a href="{% url 'main:checkout' %}"
                   class="bg-blue-600 text-white px-6 py-3 rounded hover:bg-blue-700 transition">
                    {% trans "Оформить заказ" %}
                </a>
            {% endif %}
        {% else %}
            <div class="flex flex-col items-end">
                <p class="text-red-500 mb-2">{% trans "Для оформления заказа необходимо войти в систему" %}</p>
                <div class="flex gap-2">
                    <a href="{% url 'accounts:login' %}?next={% url 'main:cart_view' %}"
                       class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                        {% trans "Войти" %}
                    </a>
                    <a href="{% url 'accounts:company_register' %}?next={% url 'main:cart_view' %}"
                       class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        {% trans "Зарегистрироваться" %}
                    </a>
                </div>
            </div>
        {% endif %}
    </div>
    {% else %}
    <div class="bg-white rounded-lg shadow p-8 text-center">
        <p class="text-gray-600 mb-4">{% trans "Ваша корзина пуста" %}</p>
        <a href="{% url 'main:home' %}"
           class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
            {% trans "Вернуться к покупкам" %}
        </a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Кэш для изображений
    const imageCache = {};
    let activeRequests = 0;
    const MAX_PARALLEL_REQUESTS = 5;
    const REQUEST_DELAY = 200;

    function loadImage(img) {
        try {
            if (!img.dataset.src) {
                img.src = '{% static 'images/no-image.jpg' %}';
                return;
            }

            if (imageCache[img.dataset.src]) {
                img.src = imageCache[img.dataset.src];
                img.classList.add('loaded');
                return;
            }

            if (activeRequests >= MAX_PARALLEL_REQUESTS) {
                setTimeout(() => loadImage(img), REQUEST_DELAY);
                return;
            }

            activeRequests++;

            const tempImg = new Image();
            tempImg.onload = function() {
                imageCache[img.dataset.src] = img.dataset.src;
                img.src = this.src;
                img.classList.add('loaded');
                activeRequests--;
            };
            tempImg.onerror = function() {
                img.src = '{% static 'images/no-image.jpg' %}';
                activeRequests--;
            };
            tempImg.src = img.dataset.src;
        } catch (e) {
            console.error('Error loading image:', e);
            img.src = '{% static 'images/no-image.jpg' %}';
        }
    }

    function initLazyLoading() {
        const lazyImages = document.querySelectorAll('.lazy-load:not(.loaded)');

        const lazyLoadObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach((entry, index) => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    if (index < 4) {
                        loadImage(img);
                    } else {
                        setTimeout(() => loadImage(img), (index - 3) * REQUEST_DELAY);
                    }
                    observer.unobserve(img);
                }
            });
        }, {
            rootMargin: '300px',
            threshold: 0.01
        });

        lazyImages.forEach(img => lazyLoadObserver.observe(img));
    }

    // Инициализация при загрузке страницы
    initLazyLoading();
});
</script>

<style>
/* Контейнер для изображения товара */
.w-48 {
    width: 8rem; /* 192px */
}
.h-48 {
    height: 8rem; /* 192px */
}

/* Плейсхолдер и ленивая загрузка */
.image-placeholder {
    animation: placeholderShimmer 1.5s linear infinite;
    background: linear-gradient(to right, #f5f5f5 8%, #e0e0e0 18%, #f5f5f5 33%);
    background-size: 800px 104px;
    position: absolute;
    inset: 0;
    z-index: 10;
}

.lazy-load {
    opacity: 0;
    transition: opacity 0.3s ease;
    object-fit: cover;
    width: 100%;
    height: 100%;
    z-index: 20;
}

.lazy-load.loaded {
    opacity: 1;
}

/* Анимация placeholder */
@keyframes placeholderShimmer {
    0% { background-position: -468px 0 }
    100% { background-position: 468px 0 }
}

/* Дополнительные стили для улучшенного отображения */
.rounded-lg {
    border-radius: 0.5rem;
}
.shadow-sm {
    box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
}
.border-gray-200 {
    border-color: #e5e7eb;
}

/* Стили для ссылки названия товара */
.hover\:text-blue-600:hover {
    color: #2563eb;
}
.transition-colors {
    transition-property: color;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    transition-duration: 150ms;
}

/* Стили для выбора размеров */
.size-quantity-input {
    width: 80px;
    padding: 0.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
}

.size-quantity-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 1px #3b82f6;
}

/* Стили для предупреждений */
.bg-yellow-50 {
    background-color: #fffbeb;
}
.border-yellow-400 {
    border-color: #fbbf24;
}
.text-yellow-700 {
    color: #92400e;
}
.bg-red-50 {
    background-color: #fef2f2;
}
.border-red-400 {
    border-color: #f87171;
}
.text-red-700 {
    color: #b91c1c;
}
</style>
{% endblock %}