{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<!-- Подключаем только CDN ресурсы -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/ru.js"></script>

<style>
.select2-container {
    min-width: 400px;
    width: 100% !important;
    margin-bottom: 20px;
}
.select2-selection--multiple {
    min-height: 42px;
}
</style>
{% endblock %}

{% block content %}
<div class="content-main">
    <form method="post" id="category-form">
        {% csrf_token %}
        <input type="hidden" name="action" value="assign_to_category">

        <h2>Обновить категории для {{ products|length }} товаров</h2>

        <div class="form-row">
            <label for="id_categories">Выберите категории:</label>
            <select name="categories" id="id_categories" multiple="multiple" style="width: 100%;"></select>
        </div>

       <form method="post" id="category-form">
    {% csrf_token %}
    <input type="hidden" name="action" value="assign_to_category">

    <h2>Обновить категории для {{ products|length }} товаров</h2>

    <div class="form-row">
        <label for="id_categories">Выберите категории:</label>
        <select name="categories" id="id_categories" multiple="multiple" style="width: 100%;"></select>
    </div>

    <div class="submit-row">
        <button type="submit" name="apply" class="button default">Применить изменения</button>
        <a href="{{ request.get_full_path }}" class="button">Отмена</a>
    </div>
</form>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // Проверяем загрузку jQuery и Select2
    if (typeof jQuery === 'undefined' || typeof $.fn.select2 === 'undefined') {
        console.error('jQuery или Select2 не загружены!');
        return;
    }

    // Инициализация Select2
    $('#id_categories').select2({
    placeholder: "Введите название категории...",
    minimumInputLength: 2,
    ajax: {
        url: 'category_search/',
        dataType: 'json',
        delay: 300,
        data: function(params) {
            return { q: params.term };
        },
        processResults: function(data) {
            if (data.error) {
                console.error("Search error:", data.error);
                return { results: [] };
            }
            return { results: data.results || [] };
        }
    },
    templateResult: function(category) {
        if (category.loading) return category.text;
        return $('<span>').text(category.text);
    }
});

    // Логирование при отправке формы
    $('#category-form').on('submit', function(e) {
        var selected = $select.val();
        console.log('Form submitted with categories:', selected);
        if (!selected || selected.length === 0) {
            alert('Пожалуйста, выберите хотя бы одну категорию');
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}